<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <title>Sahil Ultimate Cloud</title>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>
    
    <style>
        :root { --primary: #00ffcc; --bg: #000000; }
        body { background-color: var(--bg); color: #fff; font-family: sans-serif; margin: 0; padding-bottom: 100px; user-select: none; }
        
        /* Header */
        .header {
            padding: 15px; background: rgba(20,20,20,0.95); border-bottom: 1px solid #333;
            display: flex; justify-content: space-between; align-items: center;
            position: sticky; top: 0; z-index: 50; backdrop-filter: blur(5px);
        }
        .logo { font-weight: 900; color: var(--primary); letter-spacing: 1px; }
        
        /* Search */
        .search-box {
            width: 90%; background: #1a1a1a; border: 1px solid #333; margin: 10px auto;
            padding: 12px 20px; border-radius: 50px; color: #fff; font-size: 16px; display: block;
        }

        /* Grid */
        .gallery { display: grid; grid-template-columns: repeat(3, 1fr); gap: 2px; padding: 2px; }
        .item { 
            width: 100%; aspect-ratio: 1/1; object-fit: cover; 
            background: #111; position: relative; border: 1px solid #222; overflow: hidden;
        }
        
        /* Icons */
        .icon-view {
            display: flex; align-items: center; justify-content: center; flex-direction: column;
            height: 100%; width: 100%; font-size: 30px;
        }
        .pdf-style { background: #220000; color: #ff4444; }
        .vid-style { background: #001122; color: #4488ff; }
        
        .tag {
            position: absolute; bottom: 0; left: 0; width: 100%;
            background: rgba(0,0,0,0.7); font-size: 9px; padding: 2px 0;
            text-align: center; color: #fff; white-space: nowrap; overflow: hidden;
        }

        /* FAB */
        .fab-container { position: fixed; bottom: 30px; right: 20px; z-index: 100; }
        .fab {
            width: 65px; height: 65px; border-radius: 50%; border: none;
            background: var(--primary); color: #000; font-size: 30px;
            box-shadow: 0 0 20px rgba(0, 255, 204, 0.5);
        }

        /* Loading Screen */
        #ai-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 200; display: none;
            flex-direction: column; justify-content: center; align-items: center;
        }
        .progress-bar { width: 60%; height: 4px; background: #333; margin-top: 20px; }
        .progress-fill { width: 0%; height: 100%; background: var(--primary); transition: width 0.3s; }
    </style>
</head>
<body>

    <div id="ai-screen">
        <h2 style="color:var(--primary);">PROCESSING...</h2>
        <p id="ai-step" style="color:#888; font-size:12px; margin-top:10px;">Analyzing File...</p>
        <div class="progress-bar"><div class="progress-fill" id="p-fill"></div></div>
    </div>

    <div class="header">
        <div class="logo">SAHIL CLOUD</div>
        <div style="font-size:10px; color:#aaa">ALL FILES</div>
    </div>

    <input type="text" id="search" class="search-box" placeholder="Search files..." onkeyup="filter()">
    <div class="gallery" id="grid"></div>

    <div class="fab-container">
        <button class="fab" onclick="document.getElementById('inp').click()">+</button>
    </div>
    
    <input type="file" id="inp" multiple accept="image/*,video/*,application/pdf" style="display:none" onchange="startProcess()">
    
    <img id="tempImg" style="display:none" crossorigin="anonymous">
    <canvas id="compressor" style="display:none"></canvas>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, listAll } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

        // CONFIG (Tumhari wali)
        const firebaseConfig = {
            apiKey: "AIzaSyDScnh2HnQS9N60mGTRKcthHoRpxpANpB0",
            authDomain: "sahil-cloud-gallery.firebaseapp.com",
            projectId: "sahil-cloud-gallery",
            storageBucket: "sahil-cloud-gallery.firebasestorage.app",
            messagingSenderId: "324079201866",
            appId: "1:324079201866:web:634840b962a96988d280b3",
            measurementId: "G-SY8911CV7E"
        };

        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);
        const grid = document.getElementById('grid');
        let aiModel = null;

        // Load AI
        async function loadAI() { try { aiModel = await mobilenet.load(); } catch (e) {} }
        loadAI();

        // 1. SMART PROCESSOR
        window.startProcess = async function() {
            const files = document.getElementById('inp').files;
            if(!files.length) return;

            const screen = document.getElementById('ai-screen');
            const status = document.getElementById('ai-step');
            const bar = document.getElementById('p-fill');
            screen.style.display = 'flex';

            for(let i=0; i<files.length; i++) {
                const file = files[i];
                let fileToUpload = file;
                let tag = "File";
                let folder = "Others/";

                // LOGIC TREE
                if(file.type.startsWith('image')) {
                    // IMAGE: AI + Compress
                    folder = "SmartGallery/";
                    status.innerText = `üëÅÔ∏è AI Scanning: ${file.name}`;
                    bar.style.width = "30%";
                    if(aiModel) tag = await identify(file);
                    
                    status.innerText = `üíæ Compressing Image...`;
                    bar.style.width = "60%";
                    fileToUpload = await compress(file);

                } else if(file.type.startsWith('video')) {
                    // VIDEO: Direct Upload
                    folder = "Videos/";
                    tag = "Video";
                    status.innerText = `üé• Preparing Video: ${file.name}`;
                    bar.style.width = "50%";

                } else if(file.type.includes('pdf')) {
                    // PDF: Direct Upload
                    folder = "Documents/";
                    tag = "Doc";
                    status.innerText = `üìÑ Preparing PDF: ${file.name}`;
                    bar.style.width = "50%";
                }

                // UPLOAD
                status.innerText = `üöÄ Uploading...`;
                bar.style.width = "90%";
                const ext = file.name.split('.').pop();
                const newName = `${tag}_${Date.now()}.${ext}`;
                await upload(fileToUpload, folder + newName, tag);
            }

            screen.style.display = 'none';
            alert("‚úÖ ALL FILES UPLOADED!");
        };

        // Identify Image
        function identify(file) {
            return new Promise(resolve => {
                const img = document.getElementById('tempImg');
                img.src = URL.createObjectURL(file);
                img.onload = async () => {
                    const predictions = await aiModel.classify(img);
                    if(predictions && predictions.length) resolve(predictions[0].className.split(',')[0].trim());
                    else resolve("Photo");
                };
            });
        }

        // Compress Image
        function compress(file) {
            return new Promise(resolve => {
                const img = document.createElement('img');
                img.src = URL.createObjectURL(file);
                img.onload = () => {
                    const canvas = document.getElementById('compressor');
                    const ctx = canvas.getContext('2d');
                    const maxWidth = 1200;
                    const scale = maxWidth / img.width;
                    canvas.width = (scale < 1) ? maxWidth : img.width;
                    canvas.height = (scale < 1) ? img.height * scale : img.height;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    canvas.toBlob((blob) => resolve(blob), 'image/jpeg', 0.7); 
                };
            });
        }

        // Upload Helper
        function upload(file, path, tag) {
            return new Promise(resolve => {
                const sRef = ref(storage, path);
                const task = uploadBytesResumable(sRef, file);
                task.on('state_changed', null, null, () => {
                    getDownloadURL(task.snapshot.ref).then(url => {
                        show(url, path.split('/')[1], tag); // Pass filename & tag
                        resolve();
                    });
                });
            });
        }

        // Display Gallery
        function loadGallery() {
            // Load all 3 folders
            ['SmartGallery/', 'Videos/', 'Documents/'].forEach(folder => {
                listAll(ref(storage, folder)).then(res => {
                    res.items.forEach(item => getDownloadURL(item).then(u => {
                        // Determine tag based on folder or filename
                        let tag = "File";
                        if(folder.includes('Smart')) tag = item.name.split('_')[0];
                        if(folder.includes('Video')) tag = "Video";
                        if(folder.includes('Doc')) tag = "Doc";
                        show(u, item.name, tag);
                    }));
                });
            });
        }

        function show(url, name, tag) {
            const div = document.createElement('div');
            div.className = 'item';
            div.onclick = () => window.open(url, '_blank');
            div.setAttribute('data-tag', tag.toLowerCase());

            const lowerName = name.toLowerCase();

            if(lowerName.includes('.pdf')) {
                // PDF VIEW
                div.innerHTML = `<div class="icon-view pdf-style">üìÑ<span style="font-size:10px;margin-top:5px">PDF</span></div><div class="tag">${tag}</div>`;
            } else if(lowerName.includes('.mp4') || lowerName.includes('.webm') || lowerName.includes('.mov')) {
                // VIDEO VIEW
                div.innerHTML = `<div class="icon-view vid-style">‚ñ∂Ô∏è<span style="font-size:10px;margin-top:5px">VIDEO</span></div><div class="tag">${tag}</div>`;
            } else {
                // IMAGE VIEW
                div.style.backgroundImage = `url('${url}')`;
                div.innerHTML = `<div class="tag">${tag}</div>`;
            }
            grid.prepend(div);
        }

        window.filter = function() {
            const q = document.getElementById('search').value.toLowerCase();
            document.querySelectorAll('.item').forEach(el => {
                el.style.display = el.getAttribute('data-tag').includes(q) ? 'block' : 'none';
            });
        };

        loadGallery();
    </script>
</body>
</html>
